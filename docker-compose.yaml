services:
  backend:
    container_name: backend
    image: backend
    build:
      dockerfile: Dockerfile
      context: .
      target: development
    command: npm run start:debug
    ports:
      - ${PORT}:${PORT}
      - 9229:9229
    environment:
      - PG_HOSTNAME=${PG_HOSTNAME}
      - PG_USERNAME=${PG_USERNAME}
      - PG_PASSWORD=${PG_PASSWORD}
      - PG_DATABASE=${PG_DATABASE}
      - PG_PORT=${PG_PORT}
      - PG_SCHEMA=${PG_SCHEMA}
      - PG_SYNCHRONIZE=${PG_SYNCHRONIZE}
      - PG_CACERT=${PG_CACERT}

      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}

      - S3_PROTOCOL_ACCESS_KEY_ID=${S3_PROTOCOL_ACCESS_KEY_ID}
      - S3_PROTOCOL_ACCESS_KEY_SECRET=${S3_PROTOCOL_ACCESS_KEY_SECRET}

      - S3_MAX_SOCKETS=${S3_MAX_SOCKETS}
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_PUBLIC_ENDPOINT=${S3_PUBLIC_ENDPOINT}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - S3_REGION=${S3_REGION}

      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}

      - SWAGGER_USER=${SWAGGER_USER}
      - SWAGGER_PASSWORD=${SWAGGER_PASSWORD}

      - MAIL_HOST=${MAIL_HOST}
      - MAIL_SECURE=${MAIL_SECURE}
      - MAIL_FROM=${MAIL_FROM}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USER=${MAIL_USER}
      - MAIL_PASSWORD=${MAIL_PASSWORD}

      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - APP_NAME=${APP_NAME}
      - API_APP_URL=${API_APP_URL}
      - CLIENT_APP_URL=${CLIENT_APP_URL}
      - TZ=${TZ}

      - REDIS_ENABLED=${REDIS_ENABLED}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_TTL=${REDIS_TTL:-300}
    networks:
      - sqr_network
    volumes:
      - .:/usr/src/app
      - /usr/src/app/node_modules
    restart: unless-stopped
    depends_on:
      - database
      - redis
      - minio

  database:
    container_name: database
    image: postgres:latest
    ports:
      - ${PG_PORT}:5432
    environment:
      - POSTGRES_USER=${PG_USERNAME}
      - POSTGRES_PASSWORD=${PG_PASSWORD}
      - POSTGRES_DB=${PG_DATABASE}
    networks:
      - sqr_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USERNAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./src/database/seeds/init.sql:/docker-entrypoint-initdb.d/init.sql

  redis:
    container_name: redis
    image: redis:latest
    ports:
      - ${REDIS_PORT:-6379}:6379
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    networks:
      - sqr_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis_data:/data

  minio:
    container_name: minio
    image: minio/minio:latest
    ports:
      - ${MINIO_PORT:-9000}:9000
      - ${MINIO_CONSOLE_PORT:-9001}:9001
    environment:
      - MINIO_ROOT_USER=${S3_PROTOCOL_ACCESS_KEY_ID:-minioadmin}
      - MINIO_ROOT_PASSWORD=${S3_PROTOCOL_ACCESS_KEY_SECRET:-minioadmin}
    command: server /data --console-address ":9001"
    networks:
      - sqr_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    volumes:
      - minio_data:/data

networks:
  sqr_network:
    driver: bridge

volumes:
  postgres_data: {}
  redis_data: {}
  minio_data: {}
